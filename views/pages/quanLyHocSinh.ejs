<style>
    .message-box {
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        text-align: center;
    }

    .message-success {
        background-color: #d4edda;
        color: #155724;
    }

    .message-error {
        background-color: #f8d7da;
        color: #721c24;
    }

    .tab-buttons {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
    }

    .tab-button {
        padding: 8px 16px;
        background-color: #e5e7eb;
        /* Tailwind gray-200 */
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
        font-weight: 500;
    }

    .tab-button.active {
        background-color: #3b82f6;
        /* Tailwind blue-500 */
        color: white;
    }

    .tab-pane {
        display: none;
    }

    .tab-pane.active {
        display: block;
    }

    #studentDetails div {
        padding: 8px 0;
        border-bottom: 1px solid #e5e7eb;
        /* Tailwind gray-200 */
    }

    #studentDetails div:last-child {
        border-bottom: none;
        /* Remove border for the last item */
    }

    #parentDetails div {
        padding: 8px 0;
        border-bottom: 1px solid #e5e7eb;
        /* Tailwind gray-200 */
    }

    #parentDetails div:last-child {
        border-bottom: none;
        /* Remove border for the last item */
    }

    .tab-buttons {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
    }

    .tab-button {
        padding: 8px 16px;
        background-color: #e5e7eb;
        /* Tailwind gray-200 */
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .tab-button.active {
        background-color: #3b82f6;
        /* Tailwind blue-500 */
        color: white;
    }

    .tab-pane {
        display: none;
    }

    .tab-pane.active {
        display: block;
    }

    #parentSuggestions {
        max-height: 192px;
        /* max-h-48 */
        overflow-y: auto;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    #parentSuggestions div {
        cursor: pointer;
        padding: 8px 16px;
    }

    #parentSuggestions div:hover {
        background-color: #f3f4f6;
        /* Tailwind gray-100 */
    }

    .image-placeholder {
        width: 100px;
        height: 100px;
        border: 2px dashed #cbd5e0;
        /* Tailwind gray-300 */
        border-radius: 0.375rem;
        /* rounded-md */
        background-color: #f9fafb;
        /* Tailwind gray-50 */
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        overflow: hidden;
        position: relative;
    }

    .image-placeholder img {
        max-width: 100%;
        max-height: 100%;
        object-fit: cover;
        display: block;
    }

    .image-placeholder input[type="file"] {
        display: none;
    }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<div class="container mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6 text-center">Quản lý học sinh</h1>

    <div class="mb-4 flex justify-between items-center">
        <!-- TÌM KIẾM -->
        <div class="relative w-1/3">
            <form action="/hoc-sinh/tim-kiem" method="get">
                <input type="text" id="search" name="tim_kiem" placeholder="Tìm kiếm học sinh..."
                    class="border border-gray-300 rounded-md px-4 py-2 w-full focus:outline-none focus:ring focus:ring-blue-500" />
                <button class="absolute right-0 top-0 mt-2 mr-2" aria-label="Search">
                    <i class="fas fa-search text-gray-500"></i>
                </button>
            </form>
        </div>
        <!-- LỌC -->
        <form id="filterForm" action="/hoc-sinh/loc" method="get">
            <select id="vaiTroSelect" name="loai_hoc_sinh"
                class="border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring focus:ring-blue-500">
                <option value="">Tất cả học sinh</option>
                <option value="Bán trú">Bán trú</option>
                <option value="Không bán trú">Không bán trú</option>
            </select>
            <button type="submit" class="ml-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Lọc</button>
        </form>
        <button onclick="toggleAddModal()"
            class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors shadow-md focus:outline-none focus:ring focus:ring-blue-400 flex items-center gap-2">
            <i class="fas fa-plus"></i> Thêm học sinh
        </button>
    </div>
    <!-- THÊM HÀNG LOẠT -->
    <div style="float: right;" class="inline-flex">
        <!-- Thêm input file và nút upload -->
        <form id="uploadExcelForm" style="display: flex;">
            <div class="mb-4 col-span-2">
                <label for="excelFile" class="block text-sm font-medium mb-2">Tải lên file Excel</label>
                <input type="file" id="excelFile" name="excelFile" accept=".xlsx, .xls"
                    style="margin-right: 40px; width: 480px;"
                    class="border border-gray-300 rounded-md px-4 py-2 w-200px focus:outline-none focus:ring focus:ring-blue-500" />
            </div>
            <button type="button" onclick="uploadExcel()"
                style="padding-left:35px;padding-right: 20px; height: 50px; margin-top: 20px;"
                class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md transition-colors focus:outline-none focus:ring focus:ring-green-400 mt-4">
                Thêm hàng loạt
            </button>
        </form>
    </div>
    <!-- Xuất danh sách -->
    <div style="float: left;" class="inline-flex">
        <form action="/hoc-sinh/xuat-excel" method="GET">
            <button type="submit" style="padding-left:20px; padding-right: 20px; height: 50px; margin-top: 20px;"
                class="bg-green-800 hover:bg-green-700 text-white px-4 py-2 rounded-md transition-colors focus:outline-none focus:ring focus:ring-green-400 mt-4">
                Xuất Excel
            </button>
        </form>
    </div>



    <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-md">
        <thead>
            <tr class="bg-gray-200">
                <th class="py-2 px-4 border-b text-center">ID</th>
                <th class="py-2 px-4 border-b text-center">Họ tên</th>
                <th class="py-2 px-4 border-b text-center">Hình học sinh</th>
                <th class="py-2 px-4 border-b text-center">Ngày sinh</th>
                <th class="py-2 px-4 border-b text-center">Loại học sinh</th>
                <th class="py-2 px-4 border-b text-center">Hành động</th>
            </tr>
        </thead>
        <tbody id="studentTableBody">
            <% if(danhSachHocSinh && danhSachHocSinh.length> 0) { %>
                <% danhSachHocSinh.forEach((hocSinh, index)=> { %>
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="py-2 px-4 border-b text-center">
                            <%= index + 1 %>
                        </td>
                        <td class="py-2 px-4 border-b text-center">
                            <%= hocSinh.ho_ten %>
                        </td>
                        <td class="py-2 px-4 border-b text-center">
                            <% if (hocSinh.duong_dan_anh && hocSinh.duong_dan_anh.length> 0) { %>
                                <img src="/<%= hocSinh.duong_dan_anh[0] %>"
                                    class="w-16 h-16 rounded-md object-cover mx-auto" alt="Ảnh học sinh">
                                <% } else { %>
                                    <div
                                        class="w-16 h-16 rounded-md bg-gray-200 mx-auto flex items-center justify-center">
                                        <span class="text-gray-500 text-xs">No image</span>
                                    </div>
                                    <% } %>
                        </td>
                        <td class="py-2 px-4 border-b text-center">
                            <%= formatDate(hocSinh.ngay_sinh) %>
                        </td>
                        <td class="py-2 px-4 border-b text-center">
                            <%= hocSinh.loai_hoc_sinh %>
                        </td>
                        <td class="py-2 px-4 border-b text-center">
                            <!-- XEM CHI TIẾT -->
                            <button data-id="<%= hocSinh.hoc_sinh_id %>"
                                class="inline-flex items-center px-3 py-1.5 text-sm font-medium text-blue-700 bg-blue-100 rounded-md hover:bg-blue-200 focus:outline-none focus:ring focus:ring-blue-300 mr-2 transition-colors"
                                aria-label="Xem chi tiết học sinh <%= hocSinh.hoc_sinh_id %>"
                                onclick="viewDetails('<%= hocSinh.hoc_sinh_id %>')">
                                <i class="fas fa-eye mr-1"></i> Xem chi tiết
                            </button>
                            <!-- SỬA -->
                            <button
                                class="inline-flex items-center px-3 py-1.5 text-sm font-medium text-blue-700 bg-blue-100 rounded-md hover:bg-blue-200 focus:outline-none focus:ring focus:ring-blue-300 mr-2 transition-colors"
                                aria-label="Sửa học sinh 1" data-id="<%= hocSinh.hoc_sinh_id %>"
                                data-ho_ten="<%= hocSinh.ho_ten %>"
                                data-ngay_sinh="<%= formatDate(hocSinh.ngay_sinh) %>"
                                data-gioi_tinh="<%= hocSinh.gioi_tinh %>" data-dia_chi="<%= hocSinh.dia_chi %>"
                                data-loai_hoc_sinh="<%= hocSinh.loai_hoc_sinh %>"
                                data-duong_dan_anh='<%- JSON.stringify(hocSinh.duong_dan_anh || []) %>'
                                data-phu_huynh='<%= JSON.stringify(hocSinh.phu_huynh || []) %>'
                                onclick="editStudent(this)">
                                <i class="fas fa-edit mr-1"></i> Sửa
                            </button>
                            <!-- XÓA -->
                            <form action="/hoc-sinh/xoa/<%= hocSinh.hoc_sinh_id %>" method="post"
                                class="inline-flex items-center"
                                onsubmit="return confirm('Bạn có chắc chắn muốn xóa học sinh này?');">
                                <button
                                    class="inline-flex items-center px-3 py-1.5 text-sm font-medium text-red-700 bg-red-100 rounded-md hover:bg-red-200 focus:outline-none focus:ring focus:ring-red-300 transition-colors"
                                    aria-label="Xóa học sinh 1">
                                    <i class="fas fa-trash-alt mr-1"></i> Xóa
                                </button>
                            </form>
                        </td>
                    </tr>
                    <% }); %>
                        <% } else { %>
                            <tr>
                                <td colspan="7" class="py-2 px-4 border-b text-center">Không có học sinh</td>
                            </tr>
                            <% } %>
        </tbody>
    </table>

    <!-- Modal thêm học sinh -->
    <div id="addModal" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-60 hidden p-2">
        <div class="bg-white rounded-xl p-5 w-full max-w-2xl shadow-2xl max-h-[90vh] overflow-auto font-sans">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Thêm học sinh</h2>
            <form id="addStudentForm" method="post" action="/hoc-sinh/them" enctype="multipart/form-data">
                <div class="grid grid-cols-2 gap-3">
                    <div class="col-span-2">
                        <label for="fullName" class="block text-sm font-medium text-gray-700">Họ tên</label>
                        <input type="text" id="fullName" name="ho_ten" pattern="^[a-zA-ZÀ-ỹ\s]+$"
                            title="Họ tên chỉ được chứa chữ cái và khoảng trắng"
                            class="border border-gray-200 rounded-lg px-3 py-1.5 w-full focus:outline-none focus:ring-2 focus:ring-indigo-400 transition-colors bg-gray-50" />
                    </div>
                    <div>
                        <label for="dob" class="block text-sm font-medium text-gray-700">Ngày sinh</label>
                        <input type="date" id="dob" name="ngay_sinh"
                            class="border border-gray-200 rounded-lg px-3 py-1.5 w-full focus:outline-none focus:ring-2 focus:ring-indigo-400 transition-colors bg-gray-50" />
                    </div>
                    <div>
                        <label for="gender" class="block text-sm font-medium text-gray-700">Giới tính</label>
                        <select id="gender" name="gioi_tinh"
                            class="border border-gray-200 rounded-lg px-3 py-1.5 w-full focus:outline-none focus:ring-2 focus:ring-indigo-400 transition-colors bg-gray-50">
                            <option value="" disabled selected>Chọn</option>
                            <option value="Nam">Nam</option>
                            <option value="Nữ">Nữ</option>
                        </select>
                    </div>
                    <div>
                        <label for="studentType" class="block text-sm font-medium text-gray-700">Loại học sinh</label>
                        <select id="studentType" name="loai_hoc_sinh"
                            class="border border-gray-200 rounded-lg px-3 py-1.5 w-full focus:outline-none focus:ring-2 focus:ring-indigo-400 transition-colors bg-gray-50">
                            <option value="" disabled selected>Chọn</option>
                            <option value="Bán trú">Bán trú</option>
                            <option value="Không bán trú">Không bán trú</option>
                        </select>
                    </div>
                    <div class="col-span-2">
                        <label for="address" class="block text-sm font-medium text-gray-700">Địa chỉ</label>
                        <input type="text" id="address" name="dia_chi"
                            class="border border-gray-200 rounded-lg px-3 py-1.5 w-full focus:outline-none focus:ring-2 focus:ring-indigo-400 transition-colors bg-gray-50" />
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Chọn phụ huynh và mối quan hệ (ít
                            nhất 1 phụ huynh)</label>
                        <div id="phuHuynhContainer"
                            class="grid grid-cols-1 gap-2 max-h-60 overflow-auto border border-gray-200 rounded-lg p-3 bg-gray-50">
                            <% danhSachPhuHuynh.forEach(function(p) { %>
                                <div class="flex items-center gap-3">
                                    <input type="checkbox"
                                        class="ph-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-400"
                                        value="<%= p.phu_huynh_id %>" />
                                    <span>
                                        <%= p.ho_ten %> - <%= p.email %>
                                    </span>
                                    <select disabled
                                        class="ml-auto ph-select border border-gray-200 rounded px-2 py-1 text-sm bg-white text-gray-700">
                                        <option value="" selected disabled>-- Mối quan hệ --</option>
                                        <option value="Cha">Cha</option>
                                        <option value="Mẹ">Mẹ</option>
                                        <option value="Người giám hộ">Người giám hộ</option>
                                    </select>
                                </div>
                                <% }) %>
                        </div>
                    </div>
                    <!-- HÌNH ẢNH -->
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Ảnh học sinh (chọn đúng 3 ảnh)
                        </label>
                        <div class="relative w-fit mb-2">
                            <input type="file" id="duong_dan_anh" name="duong_dan_anh[]" multiple
                                accept="image/jpeg,image/png,image/jpg"
                                class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                                onchange="previewMultipleImages(this)" />
                            <div
                                class="image-placeholder w-48 h-20 flex flex-col items-center justify-center border border-gray-300 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors text-center relative z-0">
                                <span class="text-xs text-gray-500">Chọn tối đa 3 ảnh</span>
                            </div>
                        </div>
                        <!-- Vùng hiển thị preview ảnh -->
                        <div id="previewContainer" class="flex gap-4 flex-wrap mt-2"></div>
                    </div>
                </div>
                <div class="flex justify-end mt-4 gap-2">
                    <button type="button" onclick="toggleAddModal()"
                        class="bg-gray-200 text-gray-700 px-4 py-1.5 rounded-lg hover:bg-gray-300 transition-colors duration-200">Hủy</button>
                    <button type="submit"
                        class="bg-gradient-to-r from-indigo-500 to-blue-500 text-white px-4 py-1.5 rounded-lg hover:from-indigo-600 hover:to-blue-600 transition-colors duration-200">Thêm</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Sửa thông tin học sinh -->
    <div id="editModal" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-60 hidden p-2">
        <div class="bg-white rounded-xl p-5 w-full max-w-2xl shadow-2xl max-h-[90vh] overflow-auto font-sans">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Sửa thông tin học sinh</h2>
            <form id="editStudentForm" method="post" action="/hoc-sinh/sua/" enctype="multipart/form-data">
                <input type="hidden" id="studentId_edit" name="hoc_sinh_id" />
                <input type="hidden" id="removed_images" name="removed_images">
                <div class="grid grid-cols-2 gap-3">
                    <div class="col-span-2">
                        <label for="fullName_edit" class="block text-sm font-medium text-gray-700">Họ tên</label>
                        <input type="text" id="fullName_edit" name="ho_ten" pattern="^[a-zA-ZÀ-ỹ\s]+$"
                            title="Họ tên chỉ được chứa chữ cái và khoảng trắng"
                            class="border border-gray-200 rounded-lg px-3 py-1.5 w-full focus:outline-none focus:ring-2 focus:ring-indigo-400 transition-colors bg-gray-50" />
                    </div>
                    <div>
                        <label for="dob_edit" class="block text-sm font-medium text-gray-700">Ngày sinh</label>
                        <input type="date" id="dob_edit" name="ngay_sinh"
                            class="border border-gray-200 rounded-lg px-3 py-1.5 w-full focus:outline-none focus:ring-2 focus:ring-indigo-400 transition-colors bg-gray-50" />
                    </div>
                    <div>
                        <label for="gender_edit" class="block text-sm font-medium text-gray-700">Giới tính</label>
                        <select id="gender_edit" name="gioi_tinh"
                            class="border border-gray-200 rounded-lg px-3 py-1.5 w-full focus:outline-none focus:ring-2 focus:ring-indigo-400 transition-colors bg-gray-50">
                            <option value="" disabled>Chọn</option>
                            <option value="Nam">Nam</option>
                            <option value="Nữ">Nữ</option>
                        </select>
                    </div>
                    <div>
                        <label for="studentType_edit" class="block text-sm font-medium text-gray-700">Loại học
                            sinh</label>
                        <select id="studentType_edit" name="loai_hoc_sinh"
                            class="border border-gray-200 rounded-lg px-3 py-1.5 w-full focus:outline-none focus:ring-2 focus:ring-indigo-400 transition-colors bg-gray-50">
                            <option value="" disabled>Chọn</option>
                            <option value="Bán trú">Bán trú</option>
                            <option value="Không bán trú">Không bán trú</option>
                        </select>
                    </div>
                    <div class="col-span-2">
                        <label for="address_edit" class="block text-sm font-medium text-gray-700">Địa chỉ</label>
                        <input type="text" id="address_edit" name="dia_chi"
                            class="border border-gray-200 rounded-lg px-3 py-1.5 w-full focus:outline-none focus:ring-2 focus:ring-indigo-400 transition-colors bg-gray-50" />
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Chọn phụ huynh và mối quan hệ (ít
                            nhất 1 phụ huynh)</label>
                        <div id="phuHuynhContainer"
                            class="grid grid-cols-1 gap-2 max-h-60 overflow-auto border border-gray-200 rounded-lg p-3 bg-gray-50">
                            <% danhSachPhuHuynh.forEach(function(p) { %>
                                <div class="flex items-center gap-3">
                                    <input type="checkbox"
                                        class="ph-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-400"
                                        value="<%= p.phu_huynh_id %>" />
                                    <span>
                                        <%= p.ho_ten %> - <%= p.email %>
                                    </span>
                                    <select disabled
                                        class="ml-auto ph-select border border-gray-200 rounded px-2 py-1 text-sm bg-white text-gray-700">
                                        <option value="" selected disabled>-- Mối quan hệ --</option>
                                        <option value="Cha">Cha</option>
                                        <option value="Mẹ">Mẹ</option>
                                        <option value="Người giám hộ">Người giám hộ</option>
                                    </select>
                                </div>
                                <% }) %>
                        </div>
                    </div>
                    <!-- HÌNH ẢNH -->
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Ảnh học sinh (chọn đúng 3 ảnh)
                        </label>
                        <div class="relative w-fit mb-2">
                            <input type="file" id="duong_dan_anh_edit" name="duong_dan_anh[]" multiple
                                accept="image/jpeg,image/png,image/jpg"
                                class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                                onchange="previewMultipleImages(this, document.getElementById('previewContainerEdit'))" />
                            <div
                                class="image-placeholder w-48 h-20 flex flex-col items-center justify-center border border-gray-300 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors text-center relative z-0">
                                <span class="text-xs text-gray-500">Chọn tối đa 3 ảnh</span>
                            </div>
                        </div>
                        <!-- Vùng hiển thị preview ảnh -->
                        <div id="previewContainerEdit" class="flex gap-4 flex-wrap mt-2"></div>
                    </div>
                </div>
                <div class="flex justify-end mt-4 gap-2">
                    <button type="button" onclick="toggleEditModal()"
                        class="bg-gray-200 text-gray-700 px-4 py-1.5 rounded-lg hover:bg-gray-300 transition-colors duration-200">Hủy</button>
                    <button type="submit"
                        class="bg-gradient-to-r from-indigo-500 to-blue-500 text-white px-4 py-1.5 rounded-lg hover:from-indigo-600 hover:to-blue-600 transition-colors duration-200">Lưu</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Xem chi tiết học sinh -->
    <div id="detailModal" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-60 hidden p-2">
        <div class="bg-white rounded-xl p-5 w-full max-w-2xl shadow-2xl max-h-[90vh] overflow-auto font-sans">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Chi tiết học sinh</h2>

            <!-- Tab buttons -->
            <div class="tab-buttons mb-4">
                <button class="tab-button active" onclick="showTab('studentInfo')">Thông tin học sinh</button>
                <button class="tab-button" onclick="showTab('parentInfo')">Thông tin phụ huynh</button>
            </div>

            <!-- Tab panes -->
            <div id="studentInfo" class="tab-pane active">
                <div id="studentDetails" class="space-y-4">
                    <div class="flex justify-between">
                        <strong>Họ tên:</strong> <span id="studentFullName" class="text-gray-600"></span>
                    </div>
                    <div class="flex justify-between">
                        <strong>Ngày sinh:</strong> <span id="studentDOB" class="text-gray-600"></span>
                    </div>
                    <div class="flex justify-between">
                        <strong>Giới tính:</strong> <span id="studentGender" class="text-gray-600"></span>
                    </div>
                    <div class="flex justify-between">
                        <strong>Địa chỉ:</strong> <span id="studentAddress" class="text-gray-600"></span>
                    </div>
                    <div class="flex justify-between">
                        <strong>Loại học sinh:</strong> <span id="studentType_view" class="text-gray-600"></span>
                    </div>
                    <div class="flex flex-col">
                        <strong>Ảnh học sinh:</strong>
                        <div id="studentImages" class="flex gap-2 flex-wrap mt-2"></div>
                    </div>
                </div>
            </div>

            <div id="parentInfo" class="tab-pane">
                <div id="parentDetails" class="space-y-4"></div>
            </div>

            <div class="flex justify-end mt-4">
                <button type="button" onclick="toggleDetailModal()"
                    class="bg-gray-200 text-gray-700 px-4 py-1.5 rounded-lg hover:bg-gray-300 transition-colors duration-200">Đóng</button>
            </div>
        </div>
    </div>





</div>
<!-- THÊM -->
<script type="">
    const danhSachPhuHuynh = [
        <% danhSachPhuHuynh.forEach(phuHuynh => { %>
    {
        phu_huynh_id: <%= phuHuynh.phu_huynh_id %>,
        ho_ten: '<%= phuHuynh.ho_ten %>',
        email: '<%= phuHuynh.email %>'
    },
        <% }) %>
    ];
        function previewMultipleImages(input) {
        const previewContainer = document.getElementById('previewContainer');
        previewContainer.innerHTML = ''; // Xóa các ảnh cũ

        const files = input.files;
        if (!files || files.length === 0) return;

        if (files.length > 3) {
            alert("Chỉ được chọn tối đa 3 ảnh!");
            input.value = ''; // Reset input nếu vượt quá
            return;
        }

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const reader = new FileReader();

            reader.onload = function (e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = "w-32 h-32 object-cover rounded border";
                previewContainer.appendChild(img);
            };

            reader.readAsDataURL(file);
        }
    }
    
    function toggleAddModal() {
        const modal = document.getElementById('addModal');
        modal.classList.toggle('hidden');
        // Xóa nội dung tìm kiếm và gợi ý khi mở modal
        document.getElementById('parentSearch').value = '';
        document.getElementById('phu_huynh_id').value = '';
        document.getElementById('parentSuggestions').classList.add('hidden');
    }
</script>
<!-- CHECKBOX -->
<script>
    // Bật/tắt dropdown mối quan hệ khi chọn checkbox phụ huynh
    document.querySelectorAll('.ph-checkbox').forEach((checkbox) => {
        checkbox.addEventListener('change', (e) => {
            const select = e.target.closest('div').querySelector('.ph-select');
            if (e.target.checked) {
                select.disabled = false;
                select.name = 'moi_quan_he[]';
                e.target.name = 'phu_huynh_ids[]';
            } else {
                select.disabled = true;
                select.name = '';
                e.target.name = '';
            }
        });
    });
</script>
<!-- SỬA -->
<script>
    // Hàm hiển thị ảnh cũ
    function previewOldImages(images, previewContainer) {
        previewContainer.innerHTML = ''; // Xóa các ảnh cũ

        if (!Array.isArray(images)) return;

        images.forEach(img => {
            const imgDiv = document.createElement('div');
            imgDiv.className = 'relative';
            const fullSrc = img.startsWith('/') ? img : '/' + img;

            imgDiv.innerHTML = `
            <img src="${fullSrc}" class="w-20 h-20 object-cover rounded-lg" alt="Ảnh học sinh cũ" onerror="this.style.display='none'" />
            <button type="button" class="absolute top-0 right-0 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs" onclick="removeImage(this)">×</button>
        `;
            previewContainer.appendChild(imgDiv);

            console.log("Đã tạo preview ảnh cũ:", fullSrc);
        });
    }

    // Hàm xem trước ảnh mới + nút xóa
    function previewMultipleImages(input, previewContainer) {
        previewContainer.innerHTML = ''; // Xóa các ảnh cũ

        const files = input.files;
        if (!files || files.length === 0) return;

        if (files.length > 3) {
            alert("Chỉ được chọn tối đa 3 ảnh!");
            input.value = ''; // Reset input nếu vượt quá
            return;
        }

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const reader = new FileReader();

            reader.onload = function (e) {
                const imgDiv = document.createElement('div');
                imgDiv.className = 'relative';
                imgDiv.innerHTML = `
                    <img src="${e.target.result}" class="w-20 h-20 object-cover rounded-lg" alt="Ảnh mới" />
                    <button type="button" class="absolute top-0 right-0 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs" onclick="removeImage(this)">×</button>
                `;
                previewContainer.appendChild(imgDiv);
            };

            reader.readAsDataURL(file);
        }
    }

    // Hàm xóa ảnh
    function removeImage(button) {
        const imgDiv = button.parentElement;
        const imgSrc = imgDiv.querySelector('img').src;
        const removedImagesInput = document.getElementById('removed_images');
        let removedImages = removedImagesInput.value ? JSON.parse(removedImagesInput.value) : [];

        // Extract the image path
        const relativeSrc = imgSrc.replace(window.location.origin, '');
        removedImages.push(relativeSrc);
        removedImagesInput.value = JSON.stringify(removedImages);

        imgDiv.remove();
    }

    // Bật/tắt modal sửa
    function toggleEditModal() {
        const modal = document.getElementById('editModal');
        modal.classList.toggle('hidden');

        // Reset removed_images khi mở modal
        const removedImagesInput = document.getElementById('removed_images');
        if (removedImagesInput) {
            removedImagesInput.value = '';
        }
    }

    // Hàm xử lý khi bấm nút "Sửa"
    function editStudent(button) {
        console.log('Dữ liệu từ button:', button.dataset);

        const hocSinh = {
            hoc_sinh_id: button.getAttribute('data-id'),
            ho_ten: button.getAttribute('data-ho_ten'),
            ngay_sinh: button.getAttribute('data-ngay_sinh'),
            gioi_tinh: button.getAttribute('data-gioi_tinh'),
            dia_chi: button.getAttribute('data-dia_chi'),
            loai_hoc_sinh: button.getAttribute('data-loai_hoc_sinh')
        };

        // Chuyển đổi ngày sinh sang yyyy-mm-dd
        if (hocSinh.ngay_sinh) {
            const [day, month, year] = hocSinh.ngay_sinh.split('/');
            if (day && month && year) {
                document.getElementById('dob_edit').value = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            } else {
                document.getElementById('dob_edit').value = '';
                console.warn('Định dạng ngày không hợp lệ:', hocSinh.ngay_sinh);
            }
        } else {
            document.getElementById('dob_edit').value = '';
        }

        // Gán dữ liệu vào form
        document.getElementById('studentId_edit').value = hocSinh.hoc_sinh_id || '';
        document.getElementById('fullName_edit').value = hocSinh.ho_ten || '';
        document.getElementById('gender_edit').value = hocSinh.gioi_tinh || '';
        document.getElementById('studentType_edit').value = hocSinh.loai_hoc_sinh || '';
        document.getElementById('address_edit').value = hocSinh.dia_chi || '';

        // Cập nhật action form
        document.getElementById('editStudentForm').action = `/hoc-sinh/sua/${hocSinh.hoc_sinh_id || ''}`;

        // Parse & hiển thị ảnh cũ
        const rawData = button.getAttribute('data-duong_dan_anh');
        console.log("Raw data-duong_dan_anh:", rawData);

        let currentImages;
        try {
            currentImages = JSON.parse(rawData);
            if (typeof currentImages === 'string') {
                currentImages = JSON.parse(currentImages); // nếu lồng JSON thì parse thêm lần nữa
            }
            console.log("Ảnh parse thành công:", currentImages);
        } catch (e) {
            console.error("Lỗi parse JSON ảnh:", e);
            currentImages = [];
        }

        // Gán data-current-images vào input ảnh
        const duongDanAnhInput = document.getElementById('duong_dan_anh_edit');
        duongDanAnhInput.setAttribute('data-current-images', JSON.stringify(currentImages));

        // Hiển thị ảnh cũ
        const previewContainerEdit = document.getElementById('previewContainerEdit');
        previewOldImages(currentImages, previewContainerEdit);

        // Xử lý phụ huynh và mối quan hệ
        const phuHuynhData = JSON.parse(button.getAttribute('data-phu_huynh') || '[]');
        const checkboxes = document.querySelectorAll('#editModal .ph-checkbox');
        const selects = document.querySelectorAll('#editModal .ph-select');

        checkboxes.forEach((checkbox, index) => {
            const id = parseInt(checkbox.value);
            const matched = phuHuynhData.find(p => p.phu_huynh_id === id);
            if (matched) {
                checkbox.checked = true;
                selects[index].disabled = false;
                selects[index].value = matched.moi_quan_he;
                selects[index].name = 'moi_quan_he[]';
                checkbox.name = 'phu_huynh_ids[]';
            } else {
                checkbox.checked = false;
                selects[index].disabled = true;
                selects[index].value = '';
                selects[index].name = '';
                checkbox.name = '';
            }
        });

        // Bật/tắt select khi tick checkbox
        checkboxes.forEach((checkbox, index) => {
            checkbox.removeEventListener('change', handleCheckboxChange); // Xóa listener cũ
            checkbox.addEventListener('change', handleCheckboxChange);
            function handleCheckboxChange() {
                selects[index].disabled = !this.checked;
                if (!this.checked) {
                    selects[index].value = '';
                    selects[index].name = '';
                    this.name = '';
                } else {
                    selects[index].name = 'moi_quan_he[]';
                    this.name = 'phu_huynh_ids[]';
                }
            }
        });

        toggleEditModal();
    }
</script>
<!-- XEM CHI TIẾT -->
<script>
    function showTab(tabName) {
        const tabs = document.querySelectorAll('.tab-pane');
        const buttons = document.querySelectorAll('.tab-button');
        tabs.forEach(tab => {
            tab.classList.remove('active');
        });
        buttons.forEach(button => {
            button.classList.remove('active');
        });
        document.getElementById(tabName).classList.add('active');
        const activeButton = Array.from(buttons).find(button => button.textContent.includes(tabName === 'studentInfo' ? 'Thông tin học sinh' : 'Thông tin phụ huynh'));
        if (activeButton) {
            activeButton.classList.add('active');
        }
    }

    function viewDetails(id) {
        // Gọi API để lấy thông tin chi tiết
        fetch(`/hoc-sinh/chi-tiet/${id}`)
            .then(response => {
                if (!response.ok) throw new Error('Lỗi mạng hoặc không tìm thấy học sinh');
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Phản hồi không phải JSON');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    console.log('DATA:', data);

                    const hocSinh = data.data;

                    // Cập nhật thông tin học sinh
                    document.getElementById('studentFullName').textContent = hocSinh.ho_ten || '';
                    document.getElementById('studentDOB').textContent = formatDate(hocSinh.ngay_sinh) || '';
                    document.getElementById('studentGender').textContent = hocSinh.gioi_tinh || '';
                    document.getElementById('studentAddress').textContent = hocSinh.dia_chi || '';
                    document.getElementById('studentType_view').textContent = hocSinh.loai_hoc_sinh || '';

                    // Hiển thị ảnh học sinh
                    const studentImages = document.getElementById('studentImages');
                    studentImages.innerHTML = '';
                    hocSinh.duong_dan_anh.forEach(img => {
                        const imgElement = document.createElement('img');
                        imgElement.src = `/${img}`;
                        imgElement.alt = 'Ảnh học sinh';
                        imgElement.className = 'w-20 h-20 object-cover rounded-lg mr-2';
                        studentImages.appendChild(imgElement);
                    });

                    // Hiển thị thông tin phụ huynh
                    const parentDetails = document.getElementById('parentDetails');
                    parentDetails.innerHTML = '';
                    hocSinh.phu_huynh.forEach(ph => {
                        const parentHTML = `
                        <div class="ml-4 border-l-2 border-gray-200 pl-4 mb-2">
                            <div><strong>Họ tên:</strong> ${ph.ho_ten || ''}</div>
                            <div><strong>Ngày sinh:</strong> ${formatDate(ph.ngaysinh) || ''}</div>
                            <div><strong>Giới tính:</strong> ${ph.gioi_tinh || ''}</div>
                            <div><strong>Địa chỉ:</strong> ${ph.dia_chi || ''}</div>
                            <div><strong>Email:</strong> ${ph.email || ''}</div>
                            <div><strong>Mối quan hệ:</strong> ${ph.moi_quan_he || ''}</div>
                            <div><strong>Ảnh đại diện:</strong> 
                                <img src="/images/${ph.anh_dai_dien || 'default_avatar.jpg'}" alt="Ảnh đại diện" class="w-20 h-20 object-cover rounded-lg">
                            </div>
                        </div>
                    `;
                        parentDetails.innerHTML += parentHTML;
                    });

                    toggleDetailModal();
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Lỗi khi lấy chi tiết:', error);
                alert('Đã xảy ra lỗi khi xem chi tiết học sinh');
            });
    }

    function toggleDetailModal() {
        const modal = document.getElementById('detailModal');
        modal.classList.toggle('hidden');
    }

    // Hàm format date
    function formatDate(dateStr) {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();
        return `${day}/${month}/${year}`;
    }
</script>
<!-- LỌC -->
<script>
    // Set lại option đã chọn nếu có trên URL
    const urlParams = new URLSearchParams(window.location.search);
    const loaiHocSinh = urlParams.get('loai_hoc_sinh');
    if (loaiHocSinh) {
        document.getElementById('vaiTroSelect').value = loaiHocSinh;
    }
</script>
<!-- THÊM HÀNG LOẠT -->
<script>
    async function uploadExcel() {
        const fileInput = document.getElementById('excelFile');
        const file = fileInput.files[0];
        if (!file) {
            alert('Vui lòng chọn file Excel!');
            return;
        }

        const formData = new FormData();
        formData.append('excelFile', file);

        try {
            const response = await fetch('/hoc-sinh/them-hang-loat', {
                method: 'POST',
                body: formData,
                headers: {

                }
            });

            const result = await response.json();
            const messageBox = document.createElement('div');
            messageBox.className = `message-box message-${result.messageType || 'error'}`;
            messageBox.style.fontSize = '16px';

            if (response.ok) {
                messageBox.textContent = result.message;
                document.querySelector('.container').prepend(messageBox);
                setTimeout(() => location.reload(), 2000); // Refesh trang sau 2s
            } else {
                messageBox.textContent = result.message;
                if (result.danhSachLoi && result.danhSachLoi.length > 0) {
                    const errorList = document.createElement('ul');
                    errorList.className = 'list-disc list-inside mt-2';
                    result.danhSachLoi.forEach(err => {
                        const li = document.createElement('li');
                        li.textContent = `Dòng ${err.dong}: ${err.loi}`; // Thông báo lỗi
                        errorList.appendChild(li);
                    });
                    messageBox.appendChild(errorList);
                } else if (result.errorDetails) {
                    const li = document.createElement('li');
                    li.textContent = `Dòng ${result.errorDetails.dong}: ${result.errorDetails.loi}`;
                    const errorList = document.createElement('ul');
                    errorList.className = 'list-disc list-inside mt-2';
                    errorList.appendChild(li);
                    messageBox.appendChild(errorList);
                }
                document.querySelector('.container').prepend(messageBox);
            }
        } catch (error) {
            const messageBox = document.createElement('div');
            messageBox.className = 'message-box message-error';
            messageBox.textContent = 'Lỗi hệ thống khi tải lên file Excel';
            document.querySelector('.container').prepend(messageBox);
            console.error('Lỗi khi tải lên:', error);
        }
    }
</script>
<!-- FORMAT DATE -->
<% function formatDate(dateStr) { if (!dateStr) return '' ; const d=new Date(dateStr); const
    day=String(d.getDate()).padStart(2, '0' ); const month=String(d.getMonth() + 1).padStart(2, '0' ); const
    year=d.getFullYear(); return `${day}/${month}/${year}`; } %>