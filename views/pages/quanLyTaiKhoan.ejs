<style>
    .message-success {
        color: green;
        font-weight: bold;
    }

    .message-error {
        color: red;
        font-weight: bold;
    }

    .tag-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .tag {
        background-color: #e2e8f0;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .tag-remove {
        cursor: pointer;
        color: #718096;
    }

    .tag-remove:hover {
        color: #e53e3e;
    }

    .modal-hidden {
        display: none;
    }
</style>
<div class="container mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6 text-center">Quản lý tài khoản</h1>
    <div class="mb-4 flex justify-between items-center">
        <div class="relative w-1/3">
            <input type="text" id="search" placeholder="Tìm kiếm tài khoản..."
                class="border border-gray-300 rounded-md px-4 py-2 w-full focus:outline-none focus:ring focus:ring-blue-500" />
            <button class="absolute right-0 top-0 mt-2 mr-2" aria-label="Search">
                <i class="fas fa-search text-gray-500"></i>
            </button>
        </div>
        <button onclick="toggleAddModal()"
            class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors shadow-md focus:outline-none focus:ring focus:ring-blue-400 flex items-center gap-2">
            <i class="fas fa-plus"></i> Thêm tài khoản
        </button>
    </div>
    <% if (typeof message !=='undefined' && message) { %>
        <h2 class="<%= messageType === 'error' ? 'message-error' : 'message-success' %>">
            <%= message %>
        </h2>
        <% } %>

            <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-md">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="py-2 px-4 border-b text-left text-center">ID</th>
                        <th class="py-2 px-4 border-b text-left text-center">Họ tên</th>
                        <th class="py-2 px-4 border-b text-left text-center">Ngày sinh</th>
                        <th class="py-2 px-4 border-b text-left text-center">Giới tính</th>
                        <th class="py-2 px-4 border-b text-left text-center">Hành động</th>
                    </tr>
                </thead>
                <tbody id="accountTableBody">
                    <% if (danhSachTaiKhoan && danhSachTaiKhoan.length> 0) { %>
                        <% danhSachTaiKhoan.forEach(tk=> { %>
                            <tr>
                                <td class="py-2 px-4 border-b text-center">
                                    <%= tk.tai_khoan_id %>
                                </td>
                                <td class="py-2 px-4 border-b text-center">
                                    <%= tk.ho_ten %>
                                </td>
                                <td class="py-2 px-4 border-b text-center">
                                    <%= new Date(tk.ngaysinh).toLocaleDateString('vi-VN') %>
                                </td>
                                <td class="py-2 px-4 border-b text-center">
                                    <%= tk.gioi_tinh %>
                                </td>
                                <td class="py-2 px-4 border-b text-center">
                                    <!-- XEM CHI TIẾT -->
                                    <button
                                        class="inline-flex items-center px-3 py-1.5 text-sm font-medium text-blue-700 bg-blue-100 rounded-md hover:bg-blue-200 focus:outline-none focus:ring focus:ring-blue-300 mr-2 transition-colors"
                                        aria-label="Xem chi tiết tài khoản 1" onclick="viewDetails(1)">
                                        <i class="fas fa-eye mr-1"></i> Xem chi tiết
                                    </button>
                                    <!-- SỬA -->
                                    <button
                                        class="inline-flex items-center px-3 py-1.5 text-sm font-medium text-blue-700 bg-blue-100 rounded-md hover:bg-blue-200 focus:outline-none focus:ring focus:ring-blue-300 mr-2 transition-colors"
                                        aria-label="Sửa tài khoản" onclick='editAccount(this)'
                                        data-id="<%= tk.tai_khoan_id %>" data-ho_ten="<%= tk.ho_ten %>"
                                        data-email="<%= tk.email %>" data-sdt="<%= tk.sdt %>"
                                        data-ngaysinh="<%= new Date(tk.ngaysinh).toLocaleDateString('vi-VN') %>"
                                        data-gioi_tinh="<%= tk.gioi_tinh %>" data-dia_chi="<%= tk.dia_chi %>"
                                        data-so_cmnd="<%= tk.so_cmnd %>" data-ten_vai_tro="<%= tk.ten_vai_tro %>">
                                        <i class="fas fa-edit mr-1"></i> Sửa
                                    </button>
                                    <!-- XÓA -->
                                    <form action="/tai-khoan/xoa/<%= tk.tai_khoan_id %>" method="POST"
                                        class="inline-block"
                                        onsubmit="return confirm('Bạn có chắc chắn muốn xóa tài khoản này không?')">
                                        <button
                                            class="inline-flex items-center px-3 py-1.5 text-sm font-medium text-red-700 bg-red-100 rounded-md hover:bg-red-200 focus:outline-none focus:ring focus:ring-red-300 transition-colors"
                                            aria-label="Xóa tài khoản 1">
                                            <i class="fas fa-trash-alt mr-1"></i> Xóa
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            <% }); %>
                                <% } else { %>
                                    <tr>
                                        <td colspan="5" class="py-4 px-6 text-center text-gray-500">Không có tài khoản
                                            nào.</td>
                                    </tr>
                                    <% } %>
                </tbody>
            </table>

            <!-- Modal thêm tài khoản -->
            <div id="addModal"
                class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden overflow-auto p-4">
                <div class="bg-white rounded-lg p-6 w-full max-w-4xl shadow-lg max-h-full overflow-auto">
                    <h2 class="text-xl font-semibold mb-4">Thêm tài khoản</h2>
                    <form id="addAccountForm" method="post" action="/tai-khoan/them">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="mb-4">
                                <label for="fullName" class="block text-sm font-medium">Họ tên</label>
                                <input type="text" id="fullName" name="ho_ten" required
                                    class="border border-gray-300 rounded-md px-4 py-2 w-full focus:outline-none focus:ring focus:ring-blue-500" />
                            </div>
                            <div class="mb-4">
                                <label for="email" class="block text-sm font-medium">Email</label>
                                <input type="email" id="email" name="email" required
                                    class="border border-gray-300 rounded-md px-4 py-2 w-full focus:outline-none focus:ring focus:ring-blue-500" />
                            </div>
                            <div class="mb-4">
                                <label for="phone" class="block text-sm font-medium">Số điện thoại</label>
                                <input type="tel" id="phone" name="sdt" required pattern="^0\d{9}$"
                                    title="Số điện thoại phải bắt đầu bằng số 0 và có đúng 10 chữ số"
                                    class="border border-gray-300 rounded-md px-4 py-2 w-full focus:outline-none focus:ring focus:ring-blue-500" />
                            </div>
                            <div class="mb-4">
                                <label for="dob" class="block text-sm font-medium">Ngày sinh</label>
                                <input type="date" id="dob" name="ngaysinh" required
                                    class="border border-gray-300 rounded-md px-4 py-2 w-full focus:outline-none focus:ring focus:ring-blue-500" />
                            </div>
                            <div class="mb-4">
                                <label for="gender" class="block text-sm font-medium">Giới tính</label>
                                <select id="gender" name="gioi_tinh" required
                                    class="border border-gray-300 rounded-md px-4 py-2 w-full focus:outline-none focus:ring focus:ring-blue-500">
                                    <option value="" disabled selected>Chọn giới tính</option>
                                    <option value="Nam">Nam</option>
                                    <option value="Nữ">Nữ</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="role" class="block text-sm font-medium">Vai trò</label>
                                <select id="role" name="ten_vai_tro" required onchange="toggleDegreeField()"
                                    class="border border-gray-300 rounded-md px-4 py-2 w-full focus:outline-none focus:ring focus:ring-blue-500">
                                    <option value="" disabled selected>Chọn vai trò</option>
                                    <option value="Admin">Admin</option>
                                    <option value="Giáo viên">Giáo viên</option>
                                    <option value="Phụ huynh">Phụ huynh</option>
                                    <option value="Hiệu trưởng">Hiệu trưởng</option>
                                </select>
                            </div>
                            <div class="mb-4 col-span-2">
                                <label for="address" class="block text-sm font-medium">Địa chỉ</label>
                                <input type="text" id="address" name="dia_chi" required
                                    class="border border-gray-300 rounded-md px-4 py-2 w-full focus:outline-none focus:ring focus:ring-blue-500" />
                            </div>
                            <div class="mb-4 col-span-2">
                                <label for="idNumber" class="block text-sm font-medium">Số CMND/CCCD</label>
                                <input type="text" id="idNumber" name="so_cmnd" required pattern="^079\d{9}$"
                                    title="CMND/CCCD phải bắt đầu bằng 079 và có đúng 12 chữ số"
                                    class="border border-gray-300 rounded-md px-4 py-2 w-full focus:outline-none focus:ring focus:ring-blue-500" />
                            </div>
                            <div class="mb-4 col-span-2">
                                <label for="password" class="block text-sm font-medium">Mật khẩu</label>
                                <input type="password" id="password" name="mat_khau" required
                                    class="border border-gray-300 rounded-md px-4 py-2 w-full focus:outline-none focus:ring focus:ring-blue-500" />
                            </div>

                            <!-- Phần bằng cấp chỉ hiển thị khi chọn vai trò là Giáo viên -->
                            <div id="degreeSection" class="mb-4 col-span-2 hidden">
                                <div class="flex items-end gap-2">
                                    <div class="flex-grow">
                                        <label for="degree" class="block text-sm font-medium">Bằng cấp</label>
                                        <input type="text" id="degree"
                                            class="border border-gray-300 rounded-md px-4 py-2 w-full focus:outline-none focus:ring focus:ring-blue-500" />
                                    </div>
                                    <button type="button" onclick="addDegree()"
                                        class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors h-[42px]">
                                        Thêm bằng cấp
                                    </button>
                                </div>
                                <div id="degreeTags" class="tag-container">
                                    <!-- Các tag bằng cấp sẽ được thêm vào đây -->
                                </div>
                            </div>
                        </div>

                        <div class="mt-6 flex justify-end gap-4">
                            <button type="button" onclick="toggleAddModal()"
                                class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-md transition-colors focus:outline-none focus:ring focus:ring-gray-400">
                                Hủy
                            </button>
                            <button type="submit" id="saveButton"
                                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition-colors focus:outline-none focus:ring focus:ring-blue-400">
                                Lưu
                            </button>
                        </div>
                    </form>
                </div>
            </div>
</div>


<script>
    function toggleAddModal() {
        const modal = document.getElementById('addModal');
        modal.classList.toggle('hidden');

        if (!modal.classList.contains('hidden')) {
            // Khi mở modal
            document.getElementById('addAccountForm').reset();
            document.getElementById('degreeTags').innerHTML = '';
            document.getElementById('degreeSection').classList.add('hidden');

            // Reset lại form về thêm tài khoản
            document.getElementById('addAccountForm').action = '/tai-khoan/them';
            document.querySelector('#addModal h2').innerText = 'Thêm tài khoản';
            document.getElementById('saveButton').innerText = 'Lưu';
            document.getElementById('password').required = true;
        }
    }
    const modal = document.getElementById('addModal');
    modal.classList.toggle('hidden');

    if (!modal.classList.contains('hidden')) {
        // Khi mở modal: reset form và ẩn phần bằng cấp
        document.getElementById('addAccountForm').reset();
        document.getElementById('degreeTags').innerHTML = '';
        document.getElementById('degreeSection').classList.add('hidden');
    }


    function toggleDegreeField() {
        const roleSelect = document.getElementById('role');
        const degreeSection = document.getElementById('degreeSection');

        if (roleSelect.value === 'Giáo viên') {
            degreeSection.classList.remove('hidden');
        } else {
            degreeSection.classList.add('hidden');
            document.getElementById('degreeTags').innerHTML = ''; // Xóa tag nếu không phải giáo viên
        }
    }

    // Thêm bằng cấp (tag)
    function addDegree() {
        const degreeInput = document.getElementById('degree');
        const degreeValue = degreeInput.value.trim();

        if (!degreeValue) {
            alert('Vui lòng nhập bằng cấp');
            return;
        }

        const degreeTags = document.getElementById('degreeTags');
        // Kiểm tra trùng lặp
        const existingTags = degreeTags.querySelectorAll('input[name="loai_bang_cap[]"]');
        for (let tag of existingTags) {
            if (tag.value === degreeValue) {
                alert('Bằng cấp này đã được thêm.');
                degreeInput.value = '';
                return;
            }
        }

        // Tạo tag mới
        const tag = document.createElement('div');
        tag.className = 'tag';
        tag.innerHTML = `
            <span>${degreeValue}</span>
            <span class="tag-remove" onclick="removeDegree(this)">×</span>
            <input type="hidden" name="loai_bang_cap[]" value="${degreeValue}">
        `;

        degreeTags.appendChild(tag);
        degreeInput.value = ''; // Xóa input sau khi thêm
    }

    // Xóa tag bằng cấp
    function removeDegree(element) {
        element.parentElement.remove();
    }
</script>
<script>
    function editAccount(button) {
        const data = {
            id: button.dataset.id,
            ho_ten: button.dataset.ho_ten,
            email: button.dataset.email,
            sdt: button.dataset.sdt,
            ngaysinh: button.dataset.ngaysinh,
            gioi_tinh: button.dataset.gioi_tinh,
            dia_chi: button.dataset.dia_chi,
            so_cmnd: button.dataset.so_cmnd,
            ten_vai_tro: button.dataset.ten_vai_tro
        };

        // Hiển thị modal thêm tài khoản như modal sửa
        toggleAddModal();

        // Gán dữ liệu vào form
        document.getElementById('fullName').value = data.ho_ten;
        document.getElementById('email').value = data.email;
        document.getElementById('phone').value = data.sdt;

        // Format lại ngày sinh thành yyyy-MM-dd để gán vào input[type="date"]
        const parts = data.ngaysinh.split('/');
        if (parts.length === 3) {
            const formattedDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
            document.getElementById('dob').value = formattedDate;
        }

        document.getElementById('gender').value = data.gioi_tinh;
        document.getElementById('role').value = data.ten_vai_tro;
        document.getElementById('address').value = data.dia_chi;
        document.getElementById('idNumber').value = data.so_cmnd;

        // Hiển thị hoặc ẩn phần bằng cấp nếu là Giáo viên
        toggleDegreeField();

        // Đổi URL và phương thức form để gửi đến route sửa tài khoản
        const form = document.getElementById('addAccountForm');
        form.action = `/tai-khoan/sua/${data.id}`;

        // Ẩn trường mật khẩu nếu không muốn cập nhật
        document.getElementById('password').required = false;
        document.getElementById('password').value = ''; // Bỏ trống nếu không đổi mật khẩu

        // Đổi tiêu đề modal và nút
        document.querySelector('#addModal h2').innerText = 'Sửa tài khoản';
        document.getElementById('saveButton').innerText = 'Cập nhật';
    }
</script>